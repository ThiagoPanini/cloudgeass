name: "[3]⚙️ CI cloudgeass - main"

on:
  pull_request:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  ci-python:
    name: ci-python
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Instalação do Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: Instalação das Dependências
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r ./app/requirements.txt
      
      - name: Análise de Linter - flake8
        run:
          flake8 . --ignore E501

      - name: Análise de Docstrings - pydocstyle
        run:
          pydocstyle --match-dir ./app/src/*.py

      - name: Testes Unitários com pytest
        run:
          pytest app/ -vv --color=yes --cov=./ --cov-report=xml

      - name: Cobertura dos Testes - codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

    name: ci-terraform
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configuração de Credenciais AWS
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          role-session-name: OIDCSession
          aws-region: sa-east-1

      - name: Configuração e Setup do Terraform
        uses: hashicorp/setup-terraform@v2

      - name: terraform init
        run: |
          cd infra/
          terraform init

      - name: terraform plan
        run: |
          cd infra/
          terraform plan
        continue-on-error: false